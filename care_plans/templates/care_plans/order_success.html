{% extends "care_plans/base.html" %}

{% block title %}Order Created - Lamar Health{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-success text-white">
        <h2 class="mb-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
            </svg>
            Order Successfully Created
        </h2>
    </div>
    <div class="card-body">
        {% if error_message %}
        <div class="alert alert-warning">
            <h4 class="alert-heading">Order #{{ order.id }} Created</h4>
            <p class="mb-0">{{ error_message }}</p>
            <div class="mt-3">
                <button onclick="location.reload()" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    Retry Care Plan Generation
                </button>
            </div>
        </div>
        {% elif care_plan %}
        <div class="alert alert-success">
            <h4 class="alert-heading">Order #{{ order.id }} has been created!</h4>
            <p class="mb-0">Care plan has been successfully generated.</p>
        </div>
        {% else %}
        <div class="alert alert-success">
            <h4 class="alert-heading">Order #{{ order.id }} has been created!</h4>
            <p class="mb-0">The order has been saved to the system.</p>
        </div>
        {% endif %}

        {% if care_plan %}
        <div class="form-section">
            <h3>Generated Care Plan</h3>

            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <strong>Success!</strong> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}

            <div class="alert alert-info" style="font-size: 0.9rem;">
                <strong>Review & Edit:</strong> The care plan below is editable. Review the AI-generated content and make any necessary adjustments before saving or downloading.
            </div>

            <p class="text-muted" style="font-size: 0.875rem;">
                <strong>Generated:</strong> {{ care_plan.generated_at|date:"Y-m-d H:i:s" }}
                {% if care_plan.updated_at != care_plan.generated_at %}
                | <strong>Last Updated:</strong> {{ care_plan.updated_at|date:"Y-m-d H:i:s" }}
                {% endif %}
            </p>
            <form method="post" action="{% url 'update_care_plan' order.id %}" id="carePlanForm">
                {% csrf_token %}
                <textarea
                    name="care_plan_text"
                    id="carePlanTextarea"
                    class="form-control"
                    rows="25"
                    style="font-family: 'Courier New', monospace; font-size: 0.9rem; white-space: pre-wrap;"
                >{{ care_plan.care_plan_text }}</textarea>
                <div class="mt-3 d-flex gap-2">
                    <button type="submit" class="btn btn-success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                        </svg>
                        Save Changes
                    </button>
                    <a href="{% url 'download_care_plan' order.id %}" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Download Care Plan (.txt)
                    </a>
                </div>
            </form>
        </div>
        {% endif %}

        <h3 class="mt-4 mb-3">Order Details</h3>

        <div class="form-section">
            <h3>Patient Information</h3>
            <dl class="row mb-0">
                <dt class="col-sm-3">Name:</dt>
                <dd class="col-sm-9">{{ order.patient.first_name }} {{ order.patient.last_name }}</dd>

                <dt class="col-sm-3">MRN:</dt>
                <dd class="col-sm-9">{{ order.patient.mrn }}</dd>
            </dl>
        </div>

        <div class="form-section">
            <h3>Provider Information</h3>
            <dl class="row mb-0">
                <dt class="col-sm-3">Name:</dt>
                <dd class="col-sm-9">{{ order.provider.name }}</dd>

                <dt class="col-sm-3">NPI:</dt>
                <dd class="col-sm-9">{{ order.provider.npi }}</dd>
            </dl>
        </div>

        <div class="form-section">
            <h3>Clinical Information</h3>
            <dl class="row mb-0">
                <dt class="col-sm-3">Primary Diagnosis:</dt>
                <dd class="col-sm-9">{{ order.primary_diagnosis }}</dd>

                <dt class="col-sm-3">Medication:</dt>
                <dd class="col-sm-9">{{ order.medication_name }}</dd>

                {% if order.additional_diagnoses %}
                <dt class="col-sm-3">Additional Diagnoses:</dt>
                <dd class="col-sm-9">{{ order.additional_diagnoses }}</dd>
                {% endif %}

                {% if order.medication_history %}
                <dt class="col-sm-3">Medication History:</dt>
                <dd class="col-sm-9">{{ order.medication_history }}</dd>
                {% endif %}

                <dt class="col-sm-3">Patient Records:</dt>
                <dd class="col-sm-9">
                    <div style="max-height: 200px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 4px;">
                        {{ order.patient_records|linebreaks }}
                    </div>
                </dd>
            </dl>
        </div>

        <div class="d-grid gap-2 mt-4">
            <a href="{% url 'create_order' %}" class="btn btn-primary btn-lg">Create Another Order</a>
            <a href="/admin/care_plans/order/{{ order.id }}/change/" class="btn btn-outline-secondary" target="_blank">View in Admin</a>
        </div>
    </div>
</div>
{% endblock %}
